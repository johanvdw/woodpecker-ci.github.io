"use strict";(self.webpackChunkwoodpecker=self.webpackChunkwoodpecker||[]).push([[8414],{17942:(e,n,t)=>{t.d(n,{Zo:()=>p,kt:()=>f});var r=t(50959);function o(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function a(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){o(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n){if(null==e)return{};var t,r,o=function(e,n){if(null==e)return{};var t,r,o={},i=Object.keys(e);for(r=0;r<i.length;r++)t=i[r],n.indexOf(t)>=0||(o[t]=e[t]);return o}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)t=i[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(o[t]=e[t])}return o}var c=r.createContext({}),l=function(e){var n=r.useContext(c),t=n;return e&&(t="function"==typeof e?e(n):a(a({},n),e)),t},p=function(e){var n=l(e.components);return r.createElement(c.Provider,{value:n},e.children)},d="mdxType",u={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},m=r.forwardRef((function(e,n){var t=e.components,o=e.mdxType,i=e.originalType,c=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),d=l(t),m=o,f=d["".concat(c,".").concat(m)]||d[m]||u[m]||i;return t?r.createElement(f,a(a({ref:n},p),{},{components:t})):r.createElement(f,a({ref:n},p))}));function f(e,n){var t=arguments,o=n&&n.mdxType;if("string"==typeof e||o){var i=t.length,a=new Array(i);a[0]=m;var s={};for(var c in n)hasOwnProperty.call(n,c)&&(s[c]=n[c]);s.originalType=e,s[d]="string"==typeof e?e:o,a[1]=s;for(var l=2;l<i;l++)a[l]=t[l];return r.createElement.apply(null,a)}return r.createElement.apply(null,t)}m.displayName="MDXCreateElement"},66533:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>y,contentTitle:()=>b,default:()=>g,frontMatter:()=>f,metadata:()=>k,toc:()=>O});var r=t(17942),o=Object.defineProperty,i=Object.defineProperties,a=Object.getOwnPropertyDescriptors,s=Object.getOwnPropertySymbols,c=Object.prototype.hasOwnProperty,l=Object.prototype.propertyIsEnumerable,p=(e,n,t)=>n in e?o(e,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[n]=t,d=(e,n)=>{for(var t in n||(n={}))c.call(n,t)&&p(e,t,n[t]);if(s)for(var t of s(n))l.call(n,t)&&p(e,t,n[t]);return e},u=(e,n)=>i(e,a(n)),m=(e,n)=>{var t={};for(var r in e)c.call(e,r)&&n.indexOf(r)<0&&(t[r]=e[r]);if(null!=e&&s)for(var r of s(e))n.indexOf(r)<0&&l.call(e,r)&&(t[r]=e[r]);return t};const f={},b="NixOS Deployment",k={unversionedId:"administration/backends/nixos",id:"administration/backends/nixos",title:"NixOS Deployment",description:"Note that this module is not maintained by the woodpecker-developers.",source:"@site/docs/30-administration/22-backends/50-nixos.md",sourceDirName:"30-administration/22-backends",slug:"/administration/backends/nixos",permalink:"/docs/next/administration/backends/nixos",draft:!1,editUrl:"https://github.com/woodpecker-ci/woodpecker/edit/main/docs/docs/30-administration/22-backends/50-nixos.md",tags:[],version:"current",sidebarPosition:50,frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Kubernetes backend",permalink:"/docs/next/administration/backends/kubernetes"},next:{title:"Databases",permalink:"/docs/next/administration/database"}},y={},O=[{value:"General Configuration",id:"general-configuration",level:2},{value:"Tips and tricks",id:"tips-and-tricks",level:2}],h={toc:O},v="wrapper";function g(e){var n=e,{components:t}=n,o=m(n,["components"]);return(0,r.kt)(v,u(d(d({},h),o),{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",d({},{id:"nixos-deployment"}),"NixOS Deployment"),(0,r.kt)("admonition",d({},{type:"info"}),(0,r.kt)("p",{parentName:"admonition"},"Note that this module is not maintained by the woodpecker-developers.\nIf you experience issues please open a bug report in the ",(0,r.kt)("a",d({parentName:"p"},{href:"https://github.com/NixOS/nixpkgs/issues/new/choose"}),"nixpkgs repo")," where the module is maintained.")),(0,r.kt)("p",null,"The NixOS install is in theory quite similar to the binary install and supports multiple backends.\nIn practice, the settings are specified declaratively in the NixOS configuration and no manual steps need to be taken."),(0,r.kt)("h2",d({},{id:"general-configuration"}),"General Configuration"),(0,r.kt)("pre",null,(0,r.kt)("code",d({parentName:"pre"},{className:"language-nix"}),'{ config\n, ...\n}:\nlet\n  domain = "woodpecker.example.org";\nin\n{\n  # This automatically sets up certificates via let\'s encrypt\n  security.acme.defaults.email = "acme@example.com";\n  security.acme.acceptTerms = true;\n  security.acme.certs."${domain}" = { };\n\n  # Setting up a nginx proxy that handles tls for us\n  networking.firewall.allowedTCPPorts = [ 80 443 ];\n  services.nginx = {\n    enable = true;\n    recommendedTlsSettings = true;\n    recommendedOptimisation = true;\n    recommendedProxySettings = true;\n    virtualHosts."${domain}" = {\n      enableACME = true;\n      forceSSL = true;\n      locations."/" = {\n        proxyPass = "http://localhost:3007";\n      };\n    };\n  };\n\n  services.woodpecker-server = {\n    enable = true;\n    environment = {\n      WOODPECKER_HOST = "https://${domain}";\n      WOODPECKER_SERVER_ADDR = ":3007";\n      WOODPECKER_OPEN = "true";\n    };\n    # You can pass a file with env vars to the system it could look like:\n    # WOODPECKER_AGENT_SECRET=XXXXXXXXXXXXXXXXXXXXXX\n    environmentFile = "/path/to/my/secrets/file";\n  };\n\n  # This sets up a woodpecker agent\n  services.woodpecker-agents.agents."docker" = {\n    enable = true;\n    # We need this to talk to the podman socket\n    extraGroups = [ "podman" ];\n    environment = {\n      WOODPECKER_SERVER = "localhost:9000";\n      WOODPECKER_MAX_WORKFLOWS = "4";\n      DOCKER_HOST = "unix:///run/podman/podman.sock";\n      WOODPECKER_BACKEND = "docker";\n    };\n    # Same as with woodpecker-server\n    environmentFile = [ "/var/lib/secrets/woodpecker.env" ];\n  };\n\n  # Here we setup podman and enable dns\n  virtualisation.podman = {\n    enable = true;\n    defaultNetwork.settings = {\n      dns_enabled = true;\n    };\n  };\n  # This is needed for podman to be able to talk over dns\n  networking.firewall.interfaces."podman0" = {\n    allowedUDPPorts = [ 53 ];\n    allowedTCPPorts = [ 53 ];\n  };\n}\n')),(0,r.kt)("p",null,"All configuration options can be found via ",(0,r.kt)("a",d({parentName:"p"},{href:"https://search.nixos.org/options?channel=unstable&size=200&sort=relevance&query=woodpecker"}),"NixOS Search")),(0,r.kt)("h2",d({},{id:"tips-and-tricks"}),"Tips and tricks"),(0,r.kt)("p",null,"There are some resources on how to utilize Woodpecker more effectively with NixOS on the ",(0,r.kt)("a",d({parentName:"p"},{href:"/docs/next/awesome"}),"Awesome Woodpecker")," page, like using the runners nix-store in the pipeline"))}g.isMDXComponent=!0}}]);